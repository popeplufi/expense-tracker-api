{% extends "base.html" %}

{% block title %}Settings{% endblock %}

{% block content %}
<section class="section">
    <h2 class="mb-3">Settings</h2>

    <div class="card p-3 mb-3 dark-card">
        <div class="d-flex justify-content-between align-items-center gap-3">
            <div>
                <p class="mb-0 fw-semibold">@{{ g.user.username }}</p>
                <p class="mb-0 text-secondary small">{{ g.user.get('email') or 'No email set' }}</p>
            </div>
            <a href="{{ url_for('main.profile') }}" class="btn btn-outline-secondary btn-sm">Profile details</a>
        </div>
    </div>

    <div class="card p-0 mb-3 dark-card">
        <div class="settings-item">
            <div>
                <p class="mb-0 fw-semibold">Account</p>
                <p class="mb-0 text-secondary small">Security and account details</p>
            </div>
            <span class="text-secondary">></span>
        </div>
        <div class="settings-item">
            <div>
                <p class="mb-0 fw-semibold">Privacy</p>
                <p class="mb-0 text-secondary small">Blocked contacts and visibility</p>
            </div>
            <span class="text-secondary">></span>
        </div>
        <div class="settings-item">
            <div>
                <p class="mb-0 fw-semibold">Chats</p>
                <p class="mb-0 text-secondary small">Theme, wallpaper, and chat settings</p>
            </div>
            <span class="text-secondary">></span>
        </div>
        <div class="settings-item">
            <div>
                <p class="mb-0 fw-semibold">Notifications</p>
                <p class="mb-0 text-secondary small">Message and status alerts</p>
            </div>
            <span class="text-secondary">></span>
        </div>
        <div class="settings-item settings-item--last">
            <div>
                <p class="mb-0 fw-semibold">Storage and Data</p>
                <p class="mb-0 text-secondary small">Backup and media usage controls</p>
            </div>
            <span class="text-secondary">></span>
        </div>
    </div>

    <div class="card p-3 mb-3 dark-card">
        <h6 class="mb-2">Push notifications</h6>
        <p class="text-secondary small mb-2">
            Server configured:
            <strong>{{ "Yes" if push_configured else "No" }}</strong>
            | Library:
            <strong>{{ "Installed" if push_dependency_available else "Missing" }}</strong>
            | Subscriptions:
            <strong>{{ push_subscription_count }}</strong>
        </p>
        <div class="d-flex gap-2">
            <button id="pushTestBtn" class="btn btn-primary btn-sm" type="button">Send test push</button>
            <button id="pushStatusBtn" class="btn btn-outline-secondary btn-sm" type="button">Check status</button>
        </div>
        <p id="pushStatusOut" class="small mt-2 mb-0 text-secondary"></p>
    </div>

    {% if g.is_admin %}
    <div class="card p-3 mb-3 dark-card">
        <h6 class="mb-1">Admin</h6>
        <p class="text-secondary small mb-2">Review authentication activity and suspicious login attempts.</p>
        <a href="{{ url_for('main.admin_login_events_page') }}" class="btn btn-outline-secondary btn-sm">Open login logs</a>
    </div>
    {% endif %}

    <form method="post" action="{{ url_for('main.logout') }}">
        <button type="submit" class="btn btn-danger">Log out</button>
    </form>
</section>
{% endblock %}

{% block scripts %}
<script>
const pushStatusOut = document.getElementById("pushStatusOut");
const pushTestBtn = document.getElementById("pushTestBtn");
const pushStatusBtn = document.getElementById("pushStatusBtn");

async function fetchPushStatus() {
    const response = await fetch("/api/push/status", { credentials: "same-origin" });
    const data = await response.json();
    return data;
}

if (pushStatusBtn) {
    pushStatusBtn.addEventListener("click", async () => {
        try {
            const data = await fetchPushStatus();
            pushStatusOut.textContent = `configured=${data.configured} dependency=${data.dependency_available} subscriptions=${data.subscription_count}`;
        } catch (_err) {
            pushStatusOut.textContent = "Unable to fetch push status.";
        }
    });
}

if (pushTestBtn) {
    pushTestBtn.addEventListener("click", async () => {
        try {
            const response = await fetch("/api/push/test", {
                method: "POST",
                credentials: "same-origin",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({}),
            });
            const data = await response.json();
            if (!data.ok) {
                pushStatusOut.textContent = data.message || "Push test did not deliver.";
                return;
            }
            pushStatusOut.textContent = `Push delivered: ${data.delivered}/${data.total} (removed stale: ${data.removed_stale})`;
        } catch (_err) {
            pushStatusOut.textContent = "Unable to run push test.";
        }
    });
}
</script>
{% endblock %}
